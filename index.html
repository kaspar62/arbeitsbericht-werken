<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Arbeitsbericht Werken</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .student-info {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .student-input {
            display: inline-block;
            margin: 0 20px 10px 0;
        }

        .student-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .student-input input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            width: 180px;
            background: white;
            color: #2c3e50;
        }

        .student-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .page-navigation {
            padding: 20px 40px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-info {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .new-page-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .new-page-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .new-page-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .prev-btn, .next-btn {
            background: #667eea;
            color: white;
        }

        .prev-btn:hover, .next-btn:hover {
            background: #5a6fd8;
        }

        .prev-btn:disabled, .next-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .form-container {
            padding: 40px;
        }

        .date-section {
            margin-bottom: 30px;
            text-align: center;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .date-display {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
        }

        .question-section {
            margin-bottom: 35px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .question-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .question-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .question-icon {
            margin-right: 10px;
            font-size: 1.3em;
        }

        .text-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: white;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-input:disabled {
            background: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }

        .photo-section {
            background: #f0f8ff;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .photo-section:hover {
            background: #e6f3ff;
            border-color: #5a6fd8;
        }

        .photo-upload {
            display: none;
        }

        .photo-label {
            cursor: pointer;
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .photo-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .photo-label.disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .photo-preview {
            margin-top: 20px;
            display: none;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .remove-photo {
            margin-top: 10px;
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-photo:hover {
            background: #c0392b;
        }

        .remove-photo:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .submit-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .submit-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .preview-btn:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            font-size: 18px;
            padding: 20px 50px;
        }

        .export-btn:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .saved-indicator {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            color: #155724;
            text-align: center;
            font-weight: 600;
        }

        .locked-indicator {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            color: #721c24;
            text-align: center;
            font-weight: 600;
        }

        .evaluation-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }

        .evaluation-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
        }

        .evaluation-header {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        .evaluation-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .evaluation-header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .evaluation-table th,
        .evaluation-table td {
            border: 2px solid #34495e;
            padding: 12px 8px;
            text-align: left;
            vertical-align: top;
        }

        .evaluation-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .evaluation-table .criteria {
            background: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
            width: 25%;
        }

        .evaluation-table .description {
            background: #f8f9fa;
            width: 35%;
            font-style: italic;
        }

        .evaluation-table .points {
            text-align: center;
            font-weight: 600;
            background: #ffffff;
        }

        .evaluation-table .points-1 { color: #e74c3c; }
        .evaluation-table .points-2 { color: #f39c12; }
        .evaluation-table .points-3 { color: #27ae60; }

        .evaluation-goals {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .evaluation-goals h3 {
            color: #27ae60;
            margin-bottom: 10px;
            text-align: center;
        }

        .evaluation-goals ul {
            list-style: none;
            padding: 0;
        }

        .evaluation-goals li {
            padding: 5px 0;
            margin-left: 20px;
            position: relative;
        }

        .evaluation-goals li:before {
            content: "‚úì";
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            left: -20px;
        }

        .close-evaluation {
            display: block;
            width: 200px;
            margin: 25px auto 0;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-evaluation:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .copy-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .copy-text {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            text-align: left;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .copy-btn:hover {
            background: #0056b3;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin-top: 10px;
                border-radius: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .page-navigation {
                flex-direction: column;
                gap: 15px;
            }

            .student-input {
                display: block;
                margin: 10px 0;
            }

            .student-input input {
                width: 100%;
            }
            
            .evaluation-content {
                padding: 20px;
                width: 95%;
            }
            
            .evaluation-table {
                font-size: 12px;
            }
            
            .evaluation-table th,
            .evaluation-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Arbeitsbericht Werken</h1>
            <p>KASPAR HAESSIG, KUF ¬© 2024</p>
        </div>

        <div class="student-info">
            <div class="student-input">
                <label for="firstName">Vorname:</label>
                <input type="text" id="firstName" placeholder="Max" required>
            </div>
            <div class="student-input">
                <label for="lastName">Nachname:</label>
                <input type="text" id="lastName" placeholder="Mustermann" required>
            </div>
            <div class="student-input">
                <label for="className">Klasse:</label>
                <input type="text" id="className" placeholder="B26c" required>
            </div>
        </div>

        <div class="page-navigation">
            <div class="page-info">
                <span id="pageIndicator">Seite 1 von 25</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn prev-btn" id="prevBtn" disabled>
                    ‚Üê Vorherige
                </button>
                <button class="nav-btn next-btn" id="nextBtn" disabled>
                    N√§chste ‚Üí
                </button>
                <button class="nav-btn new-page-btn" id="newPageBtn">
                    ‚ûï Neue Seite
                </button>
            </div>
        </div>

        <div class="form-container">
            <div class="date-section">
                <div class="date-display" id="currentDate">
                    üìÖ Datum wird beim Erstellen einer neuen Seite gesetzt
                </div>
            </div>

            <div id="pageContent">
                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">üî®</span>
                        Was habe ich heute gemacht?
                    </div>
                    <textarea 
                        id="workDescription" 
                        class="text-input" 
                        placeholder="Beschreibe in 1-2 S√§tzen, was du heute gearbeitet hast..."
                        maxlength="200"
                        disabled
                    ></textarea>
                    <div id="desc-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">üõ†Ô∏è</span>
                        Welche Werkzeuge/Maschinen habe ich verwendet?
                    </div>
                    <textarea 
                        id="toolsUsed" 
                        class="text-input" 
                        placeholder="Liste die Werkzeuge und Maschinen auf, die du benutzt hast..."
                        maxlength="200"
                        disabled
                    ></textarea>
                    <div id="tools-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">‚ú®</span>
                        Was war neu f√ºr mich? Welche Erfahrungen habe ich gemacht?
                    </div>
                    <textarea 
                        id="newExperiences" 
                        class="text-input" 
                        placeholder="Beschreibe neue Erkenntnisse oder Erfahrungen aus der heutigen Arbeit..."
                        maxlength="200"
                        disabled
                    ></textarea>
                    <div id="exp-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">üí°</span>
                        Was h√§tte ich anders oder besser machen k√∂nnen?
                    </div>
                    <textarea 
                        id="improvements" 
                        class="text-input" 
                        placeholder="√úberlege, was du beim n√§chsten Mal verbessern k√∂nntest..."
                        maxlength="200"
                        disabled
                    ></textarea>
                    <div id="imp-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">üì∑</span>
                        Foto vom Projektstand
                    </div>
                    <div class="photo-section">
                        <input type="file" id="photoUpload" class="photo-upload" accept="image/*" disabled>
                        <label for="photoUpload" class="photo-label disabled">
                            üì∑ Foto aufnehmen/hochladen
                        </label>
                        <p style="color: #666; margin-top: 10px;">Zeige den aktuellen Stand deines Projekts</p>
                        <div id="photoPreview" class="photo-preview">
                            <img id="previewImage" src="" alt="Projekt Foto">
                            <br>
                            <button type="button" class="remove-photo" id="removePhotoBtn" disabled>
                                üóëÔ∏è Foto entfernen
                            </button>
                        </div>
                    </div>
                </div>

                <div id="pageStatus"></div>

                <div class="submit-section">
                    <button type="button" class="submit-btn preview-btn" id="previewBtn" disabled>
                        üëÄ Seite Vorschau
                    </button>
                    <button type="button" class="submit-btn" id="saveBtn" disabled>
                        üíæ Seite speichern
                    </button>
                    <br>
                    <button type="button" class="submit-btn export-btn" id="exportBtn" disabled>
                        üìÑ Bericht exportieren
                    </button>
                </div>

                <div class="copy-section" id="copySection" style="display: none;">
                    <h3>üìã Kopiere deinen Bericht f√ºr die Abgabe</h3>
                    <p>Da der automatische Download nicht funktioniert, kopiere den Text unten und f√ºge ihn in ein Word-Dokument ein:</p>
                    <div class="copy-text" id="copyText"></div>
                    <button class="copy-btn" id="copyToClipboard">üìã Text kopieren</button>
                    <p style="margin-top: 10px; font-size: 14px; color: #856404;">
                        üí° <strong>Anleitung:</strong> Text kopieren ‚Üí Word √∂ffnen ‚Üí Einf√ºgen ‚Üí Als "dein_name_datum.pdf" speichern ‚Üí An Lehrer senden
                    </p>
                </div>
            </div>
        </div>

        <!-- Evaluation Popup -->
        <div id="evaluationPopup" class="evaluation-popup" style="display: none;">
            <div class="evaluation-content">
                <div class="evaluation-header">
                    <h2>üìã Bewertung deiner Arbeitseintr√§ge</h2>
                    <p>So werden deine Eintr√§ge bewertet - achte darauf beim Ausf√ºllen!</p>
                </div>

                <div class="evaluation-goals">
                    <h3>üéØ Lernziele</h3>
                    <ul>
                        <li><strong>Arbeitsjournal f√ºhren:</strong> Dokumentiere jeden Arbeitsschritt sorgf√§ltig</li>
                        <li><strong>Reflektieren lernen:</strong> Denke √ºber deine Arbeit nach und lerne daraus</li>
                        <li><strong>Fotos nutzen:</strong> Zeige deinen Arbeitsfortschritt mit aussagekr√§ftigen Bildern</li>
                    </ul>
                </div>

                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>Bewertungskriterium</th>
                            <th>Beschreibung</th>
                            <th class="points-1">1 Punkt<br>ungen√ºgend</th>
                            <th class="points-2">2 Punkte<br>gen√ºgend</th>
                            <th class="points-3">3 Punkte<br>gut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="criteria">üìù Vollst√§ndigkeit der Eintr√§ge</td>
                            <td class="description">Jede Werkstunde sollte dokumentiert werden mit allen wichtigen Arbeitsschritten</td>
                            <td class="points points-1">Weniger als die H√§lfte der Eintr√§ge gemacht</td>
                            <td class="points points-2">Eintr√§ge sind meist da, aber haben teilweise L√ºcken</td>
                            <td class="points points-3">Alle Eintr√§ge vollst√§ndig und regelm√§√üig gemacht</td>
                        </tr>
                        <tr>
                            <td class="criteria">üí≠ Qualit√§t der Reflexion</td>
                            <td class="description">Beschreibe deine Arbeit, Werkzeuge und deine Lernerfahrungen ausf√ºhrlich und durchdacht</td>
                            <td class="points points-1">Oberfl√§chliche oder keine Reflexion</td>
                            <td class="points points-2">Grundlegende Reflexion, aber noch oberfl√§chlich</td>
                            <td class="points points-3">Durchdachte, detaillierte und ehrliche Reflexion</td>
                        </tr>
                        <tr>
                            <td class="criteria">üì∏ Aussagekraft der Fotos</td>
                            <td class="description">Fotos sollen deinen Arbeitsfortschritt gut zeigen und den Text sinnvoll erg√§nzen</td>
                            <td class="points points-1">Wenige oder unklare Fotos</td>
                            <td class="points points-2">Fotos vorhanden, aber nicht immer aussagekr√§ftig</td>
                            <td class="points points-3">Klare, gut gew√§hlte Fotos die den Fortschritt zeigen</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
                    <strong>üí° Tipp:</strong> Schreibe ehrlich und ausf√ºhrlich! Auch Fehler und Probleme sind wichtige Lernerfahrungen.
                </div>

                <button class="close-evaluation" id="closeEvaluationBtn">
                    ‚úÖ Verstanden - Weiter zum Arbeitseintrag
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables - simple and stable
        var currentPage = 0;
        var maxPages = 25;
        var pages = [];
        var studentInfo = {};

        // Initialize pages array
        for (var i = 0; i < maxPages; i++) {
            pages[i] = {
                date: null,
                workDescription: '',
                toolsUsed: '',
                newExperiences: '',
                improvements: '',
                photo: null,
                saved: false,
                locked: false
            };
        }

        // Simple event handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Show evaluation popup
            document.getElementById('evaluationPopup').style.display = 'flex';
            
            // Bind events
            document.getElementById('closeEvaluationBtn').addEventListener('click', closeEvaluationPopup);
            document.getElementById('newPageBtn').addEventListener('click', createNewPage);
            document.getElementById('prevBtn').addEventListener('click', previousPage);
            document.getElementById('nextBtn').addEventListener('click', nextPage);
            document.getElementById('saveBtn').addEventListener('click', saveCurrentPage);
            document.getElementById('previewBtn').addEventListener('click', previewCurrentPage);
            document.getElementById('exportBtn').addEventListener('click', exportReport);
            document.getElementById('photoUpload').addEventListener('change', handlePhotoUpload);
            document.getElementById('removePhotoBtn').addEventListener('click', removePhoto);
            document.getElementById('copyToClipboard').addEventListener('click', copyToClipboard);
            
            // Bind text counters
            document.getElementById('workDescription').addEventListener('input', function() {
                updateCharCounter('workDescription', 'desc-counter');
            });
            document.getElementById('toolsUsed').addEventListener('input', function() {
                updateCharCounter('toolsUsed', 'tools-counter');
            });
            document.getElementById('newExperiences').addEventListener('input', function() {
                updateCharCounter('newExperiences', 'exp-counter');
            });
            document.getElementById('improvements').addEventListener('input', function() {
                updateCharCounter('improvements', 'imp-counter');
            });
            
            updatePageDisplay();
            updateNavigation();
        });

        function closeEvaluationPopup() {
            document.getElementById('evaluationPopup').style.display = 'none';
        }

        function updateCharCounter(textareaId, counterId) {
            var textarea = document.getElementById(textareaId);
            var counter = document.getElementById(counterId);
            var current = textarea.value.length;
            var max = textarea.maxLength;
            counter.textContent = current + '/' + max + ' Zeichen';
            
            if (current > max * 0.9) {
                counter.style.color = '#e74c3c';
            } else {
                counter.style.color = '#666';
            }
        }

        function createNewPage() {
            // Save student info
            studentInfo = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                className: document.getElementById('className').value.trim()
            };

            if (!studentInfo.firstName || !studentInfo.lastName || !studentInfo.className) {
                alert('Bitte f√ºlle zuerst alle Sch√ºlerinformationen aus!');
                return;
            }

            // Find first empty page
            var emptyPageIndex = -1;
            for (var i = 0; i < maxPages; i++) {
                if (!pages[i].date) {
                    emptyPageIndex = i;
                    break;
                }
            }

            if (emptyPageIndex === -1) {
                alert('Maximale Seitenzahl (25) erreicht!');
                return;
            }

            // Create new page
            pages[emptyPageIndex] = {
                date: new Date().toISOString().split('T')[0],
                workDescription: '',
                toolsUsed: '',
                newExperiences: '',
                improvements: '',
                photo: null,
                saved: false,
                locked: false
            };

            currentPage = emptyPageIndex;
            updatePageDisplay();
            updateNavigation();
            enableEditing();

            // Lock student info
            document.getElementById('firstName').disabled = true;
            document.getElementById('lastName').disabled = true;
            document.getElementById('className').disabled = true;

            // Show evaluation popup again
            document.getElementById('evaluationPopup').style.display = 'flex';
        }

        function previousPage() {
            for (var i = currentPage - 1; i >= 0; i--) {
                if (pages[i].date) {
                    currentPage = i;
                    break;
                }
            }
            updatePageDisplay();
            updateNavigation();
            updateEditingState();
        }

        function nextPage() {
            for (var i = currentPage + 1; i < maxPages; i++) {
                if (pages[i].date) {
                    currentPage = i;
                    break;
                }
            }
            updatePageDisplay();
            updateNavigation();
            updateEditingState();
        }

        function updatePageDisplay() {
            var currentPageData = pages[currentPage];
            var pageNumber = getPageNumber(currentPage);
            
            document.getElementById('pageIndicator').textContent = 'Seite ' + pageNumber + ' von 25';
            
            if (currentPageData.date) {
                var date = new Date(currentPageData.date);
                document.getElementById('currentDate').textContent = 
                    'üìÖ ' + date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                document.getElementById('currentDate').textContent = 
                    'üìÖ Datum wird beim Erstellen einer neuen Seite gesetzt';
            }

            // Load page content
            document.getElementById('workDescription').value = currentPageData.workDescription;
            document.getElementById('toolsUsed').value = currentPageData.toolsUsed;
            document.getElementById('newExperiences').value = currentPageData.newExperiences;
            document.getElementById('improvements').value = currentPageData.improvements;

            // Update character counters
            updateCharCounter('workDescription', 'desc-counter');
            updateCharCounter('toolsUsed', 'tools-counter');
            updateCharCounter('newExperiences', 'exp-counter');
            updateCharCounter('improvements', 'imp-counter');

            // Handle photo
            if (currentPageData.photo) {
                document.getElementById('previewImage').src = currentPageData.photo;
                document.getElementById('photoPreview').style.display = 'block';
            } else {
                document.getElementById('photoPreview').style.display = 'none';
            }

            updatePageStatus();
        }

        function getPageNumber(index) {
            var count = 0;
            for (var i = 0; i <= index; i++) {
                if (pages[i].date) count++;
            }
            return count;
        }

        function updateNavigation() {
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            var newPageBtn = document.getElementById('newPageBtn');

            // Check previous pages
            var hasPrevious = false;
            for (var i = currentPage - 1; i >= 0; i--) {
                if (pages[i].date) {
                    hasPrevious = true;
                    break;
                }
            }

            // Check next pages
            var hasNext = false;
            for (var i = currentPage + 1; i < maxPages; i++) {
                if (pages[i].date) {
                    hasNext = true;
                    break;
                }
            }

            prevBtn.disabled = !hasPrevious;
            nextBtn.disabled = !hasNext;

            // Check if can create new pages
            var canCreateNew = false;
            for (var i = 0; i < maxPages; i++) {
                if (!pages[i].date) {
                    canCreateNew = true;
                    break;
                }
            }
            newPageBtn.disabled = !canCreateNew;
        }

        function updateEditingState() {
            var currentPageData = pages[currentPage];
            
            if (currentPageData.locked) {
                disableEditing();
            } else if (currentPageData.date) {
                enableEditing();
            } else {
                disableEditing();
            }
        }

        function enableEditing() {
            document.getElementById('workDescription').disabled = false;
            document.getElementById('toolsUsed').disabled = false;
            document.getElementById('newExperiences').disabled = false;
            document.getElementById('improvements').disabled = false;
            document.getElementById('photoUpload').disabled = false;
            document.querySelector('.photo-label').classList.remove('disabled');
            document.getElementById('removePhotoBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
        }

        function disableEditing() {
            document.getElementById('workDescription').disabled = true;
            document.getElementById('toolsUsed').disabled = true;
            document.getElementById('newExperiences').disabled = true;
            document.getElementById('improvements').disabled = true;
            document.getElementById('photoUpload').disabled = true;
            document.querySelector('.photo-label').classList.add('disabled');
            document.getElementById('removePhotoBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('saveBtn').disabled = true;
        }

        function updatePageStatus() {
            var currentPageData = pages[currentPage];
            var statusDiv = document.getElementById('pageStatus');
            
            if (currentPageData.locked) {
                statusDiv.innerHTML = '<div class="locked-indicator">üîí Diese Seite ist gespeichert und kann nicht mehr bearbeitet werden</div>';
            } else if (currentPageData.saved) {
                statusDiv.innerHTML = '<div class="saved-indicator">‚úÖ Seite gespeichert - du kannst noch √Ñnderungen vornehmen</div>';
            } else if (currentPageData.date) {
                statusDiv.innerHTML = '';
            } else {
                statusDiv.innerHTML = '';
            }

            // Update export button
            var exportBtn = document.getElementById('exportBtn');
            var hasPages = false;
            
            for (var i = 0; i < maxPages; i++) {
                if (pages[i].date && pages[i].saved) {
                    hasPages = true;
                    break;
                }
            }
            
            exportBtn.disabled = !hasPages;
        }

        function handlePhotoUpload(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            document.getElementById('photoUpload').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        function validateCurrentPage() {
            var currentPageData = pages[currentPage];
            
            if (!currentPageData || !currentPageData.date) {
                alert('Bitte erstelle zuerst eine neue Seite.');
                return false;
            }

            var description = document.getElementById('workDescription').value.trim();
            var tools = document.getElementById('toolsUsed').value.trim();

            if (!description) {
                alert('Bitte beschreibe, was du heute gemacht hast.');
                return false;
            }

            if (!tools) {
                alert('Bitte gib die verwendeten Werkzeuge/Maschinen an.');
                return false;
            }

            return true;
        }

        function saveCurrentPage() {
            if (!validateCurrentPage()) return;

            var currentPageData = pages[currentPage];
            
            // Save form data
            currentPageData.workDescription = document.getElementById('workDescription').value;
            currentPageData.toolsUsed = document.getElementById('toolsUsed').value;
            currentPageData.newExperiences = document.getElementById('newExperiences').value;
            currentPageData.improvements = document.getElementById('improvements').value;
            
            var photoImg = document.getElementById('previewImage');
            currentPageData.photo = photoImg.src || null;
            
            currentPageData.saved = true;
            currentPageData.locked = true;

            updatePageStatus();
            disableEditing();
            
            alert('‚úÖ Seite wurde gespeichert und ist jetzt gesperrt!');
        }

        function previewCurrentPage() {
            if (!validateCurrentPage()) return;

            var currentPageData = pages[currentPage];
            var data = {
                date: currentPageData.date,
                description: document.getElementById('workDescription').value,
                tools: document.getElementById('toolsUsed').value,
                experiences: document.getElementById('newExperiences').value,
                improvements: document.getElementById('improvements').value,
                photo: document.getElementById('previewImage').src
            };

            var previewHTML = '<h2>Arbeitsbericht vom ' + new Date(data.date).toLocaleDateString('de-DE') + '</h2>';
            previewHTML += '<h3>Was habe ich heute gemacht?</h3>';
            previewHTML += '<p>' + data.description + '</p>';
            previewHTML += '<h3>Welche Werkzeuge/Maschinen habe ich verwendet?</h3>';
            previewHTML += '<p>' + data.tools + '</p>';
            previewHTML += '<h3>Was war neu f√ºr mich? Welche Erfahrungen habe ich gemacht?</h3>';
            previewHTML += '<p>' + data.experiences + '</p>';
            previewHTML += '<h3>Was h√§tte ich anders oder besser machen k√∂nnen?</h3>';
            previewHTML += '<p>' + data.improvements + '</p>';

            if (data.photo) {
                previewHTML += '<h3>Foto</h3><img src="' + data.photo + '" style="max-width: 400px; border-radius: 8px;">';
            }

            var previewWindow = window.open('', '_blank');
            previewWindow.document.write('<html><head><title>Arbeitsbericht Vorschau</title><style>body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; } h2 { color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px; } h3 { color: #34495e; margin-top: 20px; } p { line-height: 1.6; margin-bottom: 15px; }</style></head><body>' + previewHTML + '</body></html>');
        }

        function exportReport() {
            var savedCount = 0;
            for (var i = 0; i < maxPages; i++) {
                if (pages[i].date && pages[i].saved) savedCount++;
            }

            if (savedCount === 0) {
                alert('Noch keine Seiten gespeichert!');
                return;
            }

            // Generate text version for copy-paste
            var textContent = 'ARBEITSBERICHT WERKEN\n';
            textContent += studentInfo.firstName + ' ' + studentInfo.lastName + ' - Klasse ' + studentInfo.className + '\n\n';
            textContent += 'Erstellt am: ' + new Date().toLocaleString('de-DE') + '\n';
            textContent += 'Anzahl Seiten: ' + savedCount + '\n\n';

            var count = 0;
            for (var i = 0; i < maxPages; i++) {
                if (pages[i].date && pages[i].saved) {
                    count++;
                    var date = new Date(pages[i].date);
                    textContent += '==========================================\n';
                    textContent += 'SEITE ' + count + ' - ' + date.toLocaleDateString('de-DE') + '\n';
                    textContent += '==========================================\n\n';
                    textContent += 'Was habe ich heute gemacht?\n' + pages[i].workDescription + '\n\n';
                    textContent += 'Welche Werkzeuge/Maschinen habe ich verwendet?\n' + pages[i].toolsUsed + '\n\n';
                    textContent += 'Was war neu f√ºr mich? Welche Erfahrungen habe ich gemacht?\n' + pages[i].newExperiences + '\n\n';
                    textContent += 'Was h√§tte ich anders oder besser machen k√∂nnen?\n' + pages[i].improvements + '\n\n';
                    textContent += (pages[i].photo ? '[FOTO VORHANDEN]' : '[KEIN FOTO]') + '\n\n';
                }
            }

            // Show copy section
            document.getElementById('copyText').textContent = textContent;
            document.getElementById('copySection').style.display = 'block';
            document.getElementById('copySection').scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard() {
            var copyText = document.getElementById('copyText');
            
            // Try modern clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText.textContent).then(function() {
                    alert('‚úÖ Text wurde in die Zwischenablage kopiert!\n\nJetzt kannst du ihn in Word einf√ºgen.');
                }).catch(function() {
                    // Fallback
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            var copyText = document.getElementById('copyText');
            var range = document.createRange();
            range.selectNode(copyText);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Text wurde kopiert! F√ºge ihn jetzt in Word ein.');
            } catch (err) {
                alert('Bitte markiere den Text manuell und kopiere ihn mit Cmd+C (Mac) oder Ctrl+C (Windows)');
            }
            
            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
