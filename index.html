<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitsbericht Werken</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            margin-top: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .student-info {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .student-input {
            display: inline-block;
            margin: 0 20px 10px 0;
        }

        .student-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .student-input input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            width: 150px;
        }

        .student-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .page-navigation {
            padding: 20px 40px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-info {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .new-page-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .new-page-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .new-page-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .prev-btn, .next-btn {
            background: #667eea;
            color: white;
        }

        .prev-btn:hover, .next-btn:hover {
            background: #5a6fd8;
        }

        .prev-btn:disabled, .next-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .form-container {
            padding: 40px;
        }

        .date-section {
            margin-bottom: 30px;
            text-align: center;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .date-display {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
        }

        .question-section {
            margin-bottom: 35px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .question-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .question-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .question-icon {
            margin-right: 10px;
            font-size: 1.3em;
        }

        .text-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: white;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-input:disabled {
            background: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }

        .photo-section {
            background: #f0f8ff;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .photo-section:hover {
            background: #e6f3ff;
            border-color: #5a6fd8;
        }

        .photo-upload {
            display: none;
        }

        .photo-label {
            cursor: pointer;
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .photo-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .photo-label.disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .photo-preview {
            margin-top: 20px;
            display: none;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .remove-photo {
            margin-top: 10px;
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-photo:hover {
            background: #c0392b;
        }

        .remove-photo:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .submit-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .submit-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .preview-btn:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .final-save-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            font-size: 18px;
            padding: 20px 50px;
            margin-top: 20px;
        }

        .final-save-btn:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .saved-indicator {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            color: #155724;
            text-align: center;
            font-weight: 600;
        }

        .locked-indicator {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            color: #721c24;
            text-align: center;
            font-weight: 600;
        }

        .evaluation-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }

        .evaluation-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
        }

        .evaluation-header {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        .evaluation-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .evaluation-header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .evaluation-table th,
        .evaluation-table td {
            border: 2px solid #34495e;
            padding: 12px 8px;
            text-align: left;
            vertical-align: top;
        }

        .evaluation-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .evaluation-table .criteria {
            background: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
            width: 25%;
        }

        .evaluation-table .description {
            background: #f8f9fa;
            width: 35%;
            font-style: italic;
        }

        .evaluation-table .points {
            text-align: center;
            font-weight: 600;
            background: #ffffff;
        }

        .evaluation-table .points-1 { color: #e74c3c; }
        .evaluation-table .points-2 { color: #f39c12; }
        .evaluation-table .points-3 { color: #27ae60; }

        .evaluation-goals {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .evaluation-goals h3 {
            color: #27ae60;
            margin-bottom: 10px;
            text-align: center;
        }

        .evaluation-goals ul {
            list-style: none;
            padding: 0;
        }

        .evaluation-goals li {
            padding: 5px 0;
            margin-left: 20px;
            position: relative;
        }

        .evaluation-goals li:before {
            content: "✓";
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            left: -20px;
        }

        .close-evaluation {
            display: block;
            width: 200px;
            margin: 25px auto 0;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-evaluation:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .page-navigation {
                flex-direction: column;
                gap: 15px;
            }

            .student-input {
                display: block;
                margin: 10px 0;
            }

            .student-input input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 Arbeitsbericht Werken</h1>
            <p>KASPAR HAESSIG, KUF © 2024</p>
        </div>

        <div class="student-info">
            <div class="student-input">
                <label for="firstName">Vorname:</label>
                <input type="text" id="firstName" placeholder="Max" required>
            </div>
            <div class="student-input">
                <label for="lastName">Nachname:</label>
                <input type="text" id="lastName" placeholder="Mustermann" required>
            </div>
            <div class="student-input">
                <label for="className">Klasse:</label>
                <input type="text" id="className" placeholder="B26c" required>
            </div>
        </div>

        <div class="page-navigation">
            <div class="page-info">
                <span id="pageIndicator">Seite 1 von 25</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn prev-btn" onclick="previousPage()" disabled>
                    ← Vorherige
                </button>
                <button class="nav-btn next-btn" onclick="nextPage()" disabled>
                    Nächste →
                </button>
                <button class="nav-btn new-page-btn" onclick="createNewPage()">
                    ➕ Neue Seite
                </button>
            </div>
        </div>

        <div class="form-container">
            <div class="date-section">
                <div class="date-display" id="currentDate">
                    📅 Datum wird beim Erstellen einer neuen Seite gesetzt
                </div>
            </div>

            <div id="pageContent">
                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">🔨</span>
                        Was habe ich heute gemacht?
                    </div>
                    <textarea 
                        id="workDescription" 
                        class="text-input" 
                        placeholder="Beschreibe in 1-2 Sätzen, was du heute gearbeitet hast..."
                        maxlength="200"
                        oninput="updateCharCounter('workDescription', 'desc-counter')"
                        disabled
                    ></textarea>
                    <div id="desc-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">🛠️</span>
                        Welche Werkzeuge/Maschinen habe ich verwendet?
                    </div>
                    <textarea 
                        id="toolsUsed" 
                        class="text-input" 
                        placeholder="Liste die Werkzeuge und Maschinen auf, die du benutzt hast..."
                        maxlength="200"
                        oninput="updateCharCounter('toolsUsed', 'tools-counter')"
                        disabled
                    ></textarea>
                    <div id="tools-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">✨</span>
                        Was war neu für mich? Welche Erfahrungen habe ich gemacht?
                    </div>
                    <textarea 
                        id="newExperiences" 
                        class="text-input" 
                        placeholder="Beschreibe neue Erkenntnisse oder Erfahrungen aus der heutigen Arbeit..."
                        maxlength="200"
                        oninput="updateCharCounter('newExperiences', 'exp-counter')"
                        disabled
                    ></textarea>
                    <div id="exp-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">💡</span>
                        Was hätte ich anders oder besser machen können?
                    </div>
                    <textarea 
                        id="improvements" 
                        class="text-input" 
                        placeholder="Überlege, was du beim nächsten Mal verbessern könntest..."
                        maxlength="200"
                        oninput="updateCharCounter('improvements', 'imp-counter')"
                        disabled
                    ></textarea>
                    <div id="imp-counter" class="char-counter">0/200 Zeichen</div>
                </div>

                <div class="question-section">
                    <div class="question-title">
                        <span class="question-icon">📷</span>
                        Foto vom Projektstand
                    </div>
                    <div class="photo-section">
                        <input type="file" id="photoUpload" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(event)" disabled>
                        <label for="photoUpload" class="photo-label disabled">
                            📷 Foto aufnehmen/hochladen
                        </label>
                        <p style="color: #666; margin-top: 10px;">Zeige den aktuellen Stand deines Projekts</p>
                        <div id="photoPreview" class="photo-preview">
                            <img id="previewImage" src="" alt="Projekt Foto">
                            <br>
                            <button type="button" class="remove-photo" onclick="removePhoto()" disabled>
                                🗑️ Foto entfernen
                            </button>
                        </div>
                    </div>
                </div>

                <div id="pageStatus"></div>

                <div class="submit-section">
                    <button type="button" class="submit-btn preview-btn" onclick="previewCurrentPage()" disabled>
                        👀 Seite Vorschau
                    </button>
                    <button type="button" class="submit-btn" onclick="saveCurrentPage()" disabled>
                        💾 Seite speichern
                    </button>
                    <br>
                    <button type="button" class="submit-btn final-save-btn" id="exportBtn" disabled onclick="
                        // Inline export - kann nicht verloren gehen
                        let savedCount = 0;
                        for (let i = 0; i < maxPages; i++) {
                            if (pages[i].date && pages[i].saved) savedCount++;
                        }
                        if (savedCount === 0) {
                            alert('Noch keine Seiten gespeichert!');
                            return;
                        }
                        
                        let html = '<!DOCTYPE html><html><head><title>Arbeitsbericht</title></head><body><h1>Arbeitsbericht</h1>';
                        let count = 0;
                        for (let i = 0; i < maxPages; i++) {
                            if (pages[i].date && pages[i].saved) {
                                count++;
                                html += '<h2>Seite ' + count + ' - ' + pages[i].date + '</h2>';
                                html += '<p><strong>Was gemacht:</strong> ' + pages[i].workDescription + '</p>';
                                html += '<p><strong>Werkzeuge:</strong> ' + pages[i].toolsUsed + '</p>';
                                html += '<p><strong>Erfahrungen:</strong> ' + pages[i].newExperiences + '</p>';
                                html += '<p><strong>Verbesserungen:</strong> ' + pages[i].improvements + '</p>';
                                if (pages[i].photo) {
                                    html += '<img src=\'' + pages[i].photo + '\' style=\'max-width:100%;\'>';
                                }
                                html += '<hr>';
                            }
                        }
                        html += '</body></html>';
                        
                        let blob = new Blob([html], {type: 'text/html'});
                        let url = URL.createObjectURL(blob);
                        let a = document.createElement('a');
                        a.href = url;
                        a.download = 'arbeitsbericht_' + studentInfo.firstName + '.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Download gestartet!');
                    ">
                        📄 Bericht exportieren
                    </button>
                </div>
            </div>
        </div>

        <!-- Evaluation Popup -->
        <div id="evaluationPopup" class="evaluation-popup" style="display: none;">
            <div class="evaluation-content">
                <div class="evaluation-header">
                    <h2>📋 Bewertung deiner Arbeitseinträge</h2>
                    <p>So werden deine Einträge bewertet - achte darauf beim Ausfüllen!</p>
                </div>

                <div class="evaluation-goals">
                    <h3>🎯 Lernziele</h3>
                    <ul>
                        <li><strong>Arbeitsjournal führen:</strong> Dokumentiere jeden Arbeitsschritt sorgfältig</li>
                        <li><strong>Reflektieren lernen:</strong> Denke über deine Arbeit nach und lerne daraus</li>
                        <li><strong>Fotos nutzen:</strong> Zeige deinen Arbeitsfortschritt mit aussagekräftigen Bildern</li>
                    </ul>
                </div>

                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>Bewertungskriterium</th>
                            <th>Beschreibung</th>
                            <th class="points-1">1 Punkt<br>ungenügend</th>
                            <th class="points-2">2 Punkte<br>genügend</th>
                            <th class="points-3">3 Punkte<br>gut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="criteria">📝 Vollständigkeit der Einträge</td>
                            <td class="description">Jede Werkstunde sollte dokumentiert werden mit allen wichtigen Arbeitsschritten</td>
                            <td class="points points-1">Weniger als die Hälfte der Einträge gemacht</td>
                            <td class="points points-2">Einträge sind meist da, aber haben teilweise Lücken</td>
                            <td class="points points-3">Alle Einträge vollständig und regelmäßig gemacht</td>
                        </tr>
                        <tr>
                            <td class="criteria">💭 Qualität der Reflexion</td>
                            <td class="description">Beschreibe deine Arbeit, Werkzeuge und deine Lernerfahrungen ausführlich und durchdacht</td>
                            <td class="points points-1">Oberflächliche oder keine Reflexion</td>
                            <td class="points points-2">Grundlegende Reflexion, aber noch oberflächlich</td>
                            <td class="points points-3">Durchdachte, detaillierte und ehrliche Reflexion</td>
                        </tr>
                        <tr>
                            <td class="criteria">📸 Aussagekraft der Fotos</td>
                            <td class="description">Fotos sollen deinen Arbeitsfortschritt gut zeigen und den Text sinnvoll ergänzen</td>
                            <td class="points points-1">Wenige oder unklare Fotos</td>
                            <td class="points points-2">Fotos vorhanden, aber nicht immer aussagekräftig</td>
                            <td class="points points-3">Klare, gut gewählte Fotos die den Fortschritt zeigen</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
                    <strong>💡 Tipp:</strong> Schreibe ehrlich und ausführlich! Auch Fehler und Probleme sind wichtige Lernerfahrungen.
                </div>

                <button class="close-evaluation" onclick="closeEvaluationPopup()">
                    ✅ Verstanden - Weiter zum Arbeitseintrag
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 0;
        let maxPages = 25;
        let pages = [];
        let studentInfo = {};

        // Show evaluation popup
        function showEvaluationPopup() {
            document.getElementById('evaluationPopup').style.display = 'flex';
        }

        function closeEvaluationPopup() {
            document.getElementById('evaluationPopup').style.display = 'none';
        }

        // Initialize
        function init() {
            // Try to load existing data from localStorage
            try {
                const savedData = localStorage.getItem('arbeitsberichtData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    pages = data.pages || [];
                    studentInfo = data.studentInfo || {};
                    currentPage = data.currentPage || 0;
                    
                    // Restore student info if available
                    if (studentInfo.firstName) {
                        document.getElementById('firstName').value = studentInfo.firstName;
                        document.getElementById('lastName').value = studentInfo.lastName;
                        document.getElementById('className').value = studentInfo.className;
                        
                        // Lock student info if data exists
                        document.getElementById('firstName').disabled = true;
                        document.getElementById('lastName').disabled = true;
                        document.getElementById('className').disabled = true;
                    }
                }
            } catch (e) {
                console.log('No saved data found, starting fresh');
            }

            // Initialize empty pages array if not loaded
            if (pages.length === 0) {
                for (let i = 0; i < maxPages; i++) {
                    pages[i] = {
                        date: null,
                        workDescription: '',
                        toolsUsed: '',
                        newExperiences: '',
                        improvements: '',
                        photo: null,
                        saved: false,
                        locked: false
                    };
                }
            }
            
            updatePageDisplay();
            updateNavigation();
            updateEditingState();
            
            // Show evaluation popup on startup
            showEvaluationPopup();
        }

        // Save data to localStorage whenever something changes
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    pages: pages,
                    studentInfo: studentInfo,
                    currentPage: currentPage,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('arbeitsberichtData', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function updateCharCounter(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            const current = textarea.value.length;
            const max = textarea.maxLength;
            counter.textContent = current + '/' + max + ' Zeichen';
            
            if (current > max * 0.9) {
                counter.style.color = '#e74c3c';
            } else {
                counter.style.color = '#666';
            }
        }

        function createNewPage() {
            // Save current student info
            studentInfo = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                className: document.getElementById('className').value
            };

            if (!studentInfo.firstName || !studentInfo.lastName || !studentInfo.className) {
                alert('Bitte fülle zuerst alle Schülerinformationen aus!');
                return;
            }

            // Find first empty page
            let emptyPageIndex = -1;
            for (let i = 0; i < maxPages; i++) {
                if (!pages[i].date) {
                    emptyPageIndex = i;
                    break;
                }
            }

            if (emptyPageIndex === -1) {
                alert('Maximale Seitenzahl (25) erreicht!');
                return;
            }

            // Create new page with current date
            pages[emptyPageIndex] = {
                date: new Date().toISOString().split('T')[0],
                workDescription: '',
                toolsUsed: '',
                newExperiences: '',
                improvements: '',
                photo: null,
                saved: false,
                locked: false
            };

            // Switch to new page
            currentPage = emptyPageIndex;
            
            // Save to localStorage
            saveToLocalStorage();
            
            updatePageDisplay();
            updateNavigation();
            enableEditing();

            // Show evaluation popup when creating new page
            showEvaluationPopup();

            // Lock student info after first page
            if (emptyPageIndex === 0) {
                document.getElementById('firstName').disabled = true;
                document.getElementById('lastName').disabled = true;
                document.getElementById('className').disabled = true;
            }
        }

        function previousPage() {
            if (currentPage > 0) {
                for (let i = currentPage - 1; i >= 0; i--) {
                    if (pages[i].date) {
                        currentPage = i;
                        break;
                    }
                }
                updatePageDisplay();
                updateNavigation();
                updateEditingState();
            }
        }

        function nextPage() {
            if (currentPage < maxPages - 1) {
                for (let i = currentPage + 1; i < maxPages; i++) {
                    if (pages[i].date) {
                        currentPage = i;
                        break;
                    }
                }
                updatePageDisplay();
                updateNavigation();
                updateEditingState();
            }
        }

        function updatePageDisplay() {
            const currentPageData = pages[currentPage];
            const pageNumber = getPageNumber(currentPage);
            
            document.getElementById('pageIndicator').textContent = 'Seite ' + pageNumber + ' von 25';
            
            if (currentPageData.date) {
                const date = new Date(currentPageData.date);
                document.getElementById('currentDate').textContent = 
                    '📅 ' + date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                document.getElementById('currentDate').textContent = 
                    '📅 Datum wird beim Erstellen einer neuen Seite gesetzt';
            }

            // Load page content
            document.getElementById('workDescription').value = currentPageData.workDescription;
            document.getElementById('toolsUsed').value = currentPageData.toolsUsed;
            document.getElementById('newExperiences').value = currentPageData.newExperiences;
            document.getElementById('improvements').value = currentPageData.improvements;

            // Update character counters
            updateCharCounter('workDescription', 'desc-counter');
            updateCharCounter('toolsUsed', 'tools-counter');
            updateCharCounter('newExperiences', 'exp-counter');
            updateCharCounter('improvements', 'imp-counter');

            // Handle photo
            if (currentPageData.photo) {
                document.getElementById('previewImage').src = currentPageData.photo;
                document.getElementById('photoPreview').style.display = 'block';
            } else {
                document.getElementById('photoPreview').style.display = 'none';
            }

            // Update page status
            updatePageStatus();
        }

        function getPageNumber(index) {
            let count = 0;
            for (let i = 0; i <= index; i++) {
                if (pages[i].date) count++;
            }
            return count;
        }

        function updateNavigation() {
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            const newPageBtn = document.querySelector('.new-page-btn');

            // Check if there are previous pages
            let hasPrevious = false;
            for (let i = currentPage - 1; i >= 0; i--) {
                if (pages[i].date) {
                    hasPrevious = true;
                    break;
                }
            }

            // Check if there are next pages
            let hasNext = false;
            for (let i = currentPage + 1; i < maxPages; i++) {
                if (pages[i].date) {
                    hasNext = true;
                    break;
                }
            }

            prevBtn.disabled = !hasPrevious;
            nextBtn.disabled = !hasNext;

            // Check if we can create new pages
            let canCreateNew = false;
            for (let i = 0; i < maxPages; i++) {
                if (!pages[i].date) {
                    canCreateNew = true;
                    break;
                }
            }
            newPageBtn.disabled = !canCreateNew;
        }

        function updateEditingState() {
            const currentPageData = pages[currentPage];
            
            if (currentPageData.locked) {
                disableEditing();
            } else if (currentPageData.date) {
                enableEditing();
            } else {
                disableEditing();
            }
        }

        function enableEditing() {
            document.getElementById('workDescription').disabled = false;
            document.getElementById('toolsUsed').disabled = false;
            document.getElementById('newExperiences').disabled = false;
            document.getElementById('improvements').disabled = false;
            document.getElementById('photoUpload').disabled = false;
            document.querySelector('.photo-label').classList.remove('disabled');
            document.querySelector('.remove-photo').disabled = false;
            const submitBtns = document.querySelectorAll('.submit-btn:not(.final-save-btn)');
            document.querySelector('.preview-btn').disabled = false;
            submitBtns.forEach(btn => btn.disabled = false);
        }

        function disableEditing() {
            document.getElementById('workDescription').disabled = true;
            document.getElementById('toolsUsed').disabled = true;
            document.getElementById('newExperiences').disabled = true;
            document.getElementById('improvements').disabled = true;
            document.getElementById('photoUpload').disabled = true;
            document.querySelector('.photo-label').classList.add('disabled');
            document.querySelector('.remove-photo').disabled = true;
            document.querySelector('.preview-btn').disabled = true;
            document.querySelector('.submit-btn').disabled = true;
        }

        function updatePageStatus() {
            const currentPageData = pages[currentPage];
            const statusDiv = document.getElementById('pageStatus');
            
            if (currentPageData.locked) {
                statusDiv.innerHTML = '<div class="locked-indicator">🔒 Diese Seite ist gespeichert und kann nicht mehr bearbeitet werden</div>';
            } else if (currentPageData.saved) {
                statusDiv.innerHTML = '<div class="saved-indicator">✅ Seite gespeichert - du kannst noch Änderungen vornehmen</div>';
            } else if (currentPageData.date) {
                statusDiv.innerHTML = '';
            } else {
                statusDiv.innerHTML = '';
            }

            // Update export button (only button now)
            const exportBtn = document.getElementById('exportBtn');
            let hasPages = false;
            
            for (let i = 0; i < maxPages; i++) {
                if (pages[i].date && pages[i].saved) {
                    hasPages = true;
                    break;
                }
            }
            
            if (exportBtn) {
                exportBtn.disabled = !hasPages;
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            document.getElementById('photoUpload').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        function validateCurrentPage() {
            const currentPageData = pages[currentPage];
            
            if (!currentPageData || !currentPageData.date) {
                alert('Bitte erstelle zuerst eine neue Seite.');
                return false;
            }

            const description = document.getElementById('workDescription').value.trim();
            const tools = document.getElementById('toolsUsed').value.trim();

            if (!description) {
                alert('Bitte beschreibe, was du heute gemacht hast.');
                return false;
            }

            if (!tools) {
                alert('Bitte gib die verwendeten Werkzeuge/Maschinen an.');
                return false;
            }

            return true;
        }

        function saveCurrentPage() {
            if (!validateCurrentPage()) return;

            const currentPageData = pages[currentPage];
            
            // Save current form data to page
            currentPageData.workDescription = document.getElementById('workDescription').value;
            currentPageData.toolsUsed = document.getElementById('toolsUsed').value;
            currentPageData.newExperiences = document.getElementById('newExperiences').value;
            currentPageData.improvements = document.getElementById('improvements').value;
            currentPageData.photo = document.getElementById('previewImage').src;
            currentPageData.saved = true;
            currentPageData.locked = true; // Lock after saving

            // Save to localStorage
            saveToLocalStorage();

            // Update UI
            updatePageStatus();
            disableEditing();
            
            alert('✅ Seite wurde gespeichert und ist jetzt gesperrt!');
        }

        function previewCurrentPage() {
            if (!validateCurrentPage()) return;

            const currentPageData = pages[currentPage];
            const data = {
                date: currentPageData.date,
                description: document.getElementById('workDescription').value,
                tools: document.getElementById('toolsUsed').value,
                experiences: document.getElementById('newExperiences').value,
                improvements: document.getElementById('improvements').value,
                photo: document.getElementById('previewImage').src
            };

            let previewHTML = '<h2>Arbeitsbericht vom ' + new Date(data.date).toLocaleDateString('de-DE') + '</h2>';
            previewHTML += '<h3>Was habe ich heute gemacht?</h3>';
            previewHTML += '<p>' + data.description + '</p>';
            previewHTML += '<h3>Welche Werkzeuge/Maschinen habe ich verwendet?</h3>';
            previewHTML += '<p>' + data.tools + '</p>';
            previewHTML += '<h3>Was war neu für mich? Welche Erfahrungen habe ich gemacht?</h3>';
            previewHTML += '<p>' + data.experiences + '</p>';
            previewHTML += '<h3>Was hätte ich anders oder besser machen können?</h3>';
            previewHTML += '<p>' + data.improvements + '</p>';

            if (data.photo) {
                previewHTML += '<h3>Foto</h3><img src="' + data.photo + '" style="max-width: 400px; border-radius: 8px;">';
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write('<html><head><title>Arbeitsbericht Vorschau</title><style>body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; } h2 { color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px; } h3 { color: #34495e; margin-top: 20px; } p { line-height: 1.6; margin-bottom: 15px; }</style></head><body>' + previewHTML + '</body></html>');
        }

        function finalSaveAndDownload() {
            // Generate PDF content
            let pdfContent = 'ARBEITSBERICHT WERKEN\n';
            pdfContent += studentInfo.firstName + ' ' + studentInfo.lastName + ' - Klasse ' + studentInfo.className + '\n\n';
            pdfContent += 'Generiert am: ' + new Date().toLocaleString('de-DE') + '\n\n';

            let pageCount = 0;
            for (let i = 0; i < maxPages; i++) {
                if (pages[i].date && pages[i].saved) {
                    pageCount++;
                    const date = new Date(pages[i].date);
                    pdfContent += '\n==========================================\n';
                    pdfContent += 'SEITE ' + pageCount + ' - ' + date.toLocaleDateString('de-DE') + '\n';
                    pdfContent += '==========================================\n\n';
                    pdfContent += 'Was habe ich heute gemacht?\n' + pages[i].workDescription + '\n\n';
                    pdfContent += 'Welche Werkzeuge/Maschinen habe ich verwendet?\n' + pages[i].toolsUsed + '\n\n';
                    pdfContent += 'Was war neu für mich? Welche Erfahrungen habe ich gemacht?\n' + pages[i].newExperiences + '\n\n';
                    pdfContent += 'Was hätte ich anders oder besser machen können?\n' + pages[i].improvements + '\n\n';
                    pdfContent += (pages[i].photo ? '[FOTO VORHANDEN]' : '[KEIN FOTO]') + '\n\n';
                }
            }

            const fileName = studentInfo.firstName + '.' + studentInfo.lastName + '_' + studentInfo.className + '.txt';

            // Create downloadable file with "Save As" dialog
            const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8' });
            
            // Check if browser supports the new File System Access API
            if ('showSaveFilePicker' in window) {
                // Use modern "Save As" dialog
                window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Text files',
                        accept: { 'text/plain': ['.txt'] }
                    }]
                }).then(async (fileHandle) => {
                    const writableStream = await fileHandle.createWritable();
                    await writableStream.write(blob);
                    await writableStream.close();
                    alert('✅ Arbeitsbericht wurde erfolgreich gespeichert!\n\nInsgesamt ' + pageCount + ' Seiten gespeichert.');
                }).catch((err) => {
                    // User cancelled or error occurred, fallback to regular download
                    if (err.name !== 'AbortError') {
                        downloadFile(blob, fileName, pageCount);
                    }
                });
            } else {
                // Fallback to regular download for older browsers
                downloadFile(blob, fileName, pageCount);
            }
        }

        function downloadFile(blob, fileName, pageCount) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('✅ Arbeitsbericht wurde erfolgreich als "' + fileName + '" heruntergeladen!\n\nInsgesamt ' + pageCount + ' Seiten gespeichert.');
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
